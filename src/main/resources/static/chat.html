<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Netty 聊天Demo</title>
    <style>
        .container { width: 800px; margin: 0 auto; }
        .msg-list { height: 400px; border: 1px solid #ccc; padding: 10px; overflow-y: auto; margin-bottom: 10px; }
        .msg { margin: 5px 0; padding: 8px; border-radius: 4px; }
        .system-msg { background: #f5f5f5; color: #666; text-align: center; }
        .send-msg { background: #e1f5fe; text-align: right; }
        .recv-msg { background: #f3e5f5; text-align: left; }
        .input-area { display: flex; gap: 10px; }
        input, select, button { padding: 8px; flex: 1; }
        button { flex: 0.5; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
<div class="container">
    <h1>Netty 聊天Demo</h1>
    <div>
        用户名：<input type="text" id="userId" placeholder="输入用户名">
        <button onclick="login()">登录</button>
    </div>
    <div class="msg-list" id="msgList"></div>
    <div class="input-area">
        <select id="receiverType">
            <option value="single">单聊</option>
            <option value="group">群聊</option>
        </select>
        <input type="text" id="receiverId" placeholder="单聊输入对方ID，群聊留空">
        <input type="text" id="msgContent" placeholder="输入消息内容">
        <button onclick="sendMsg()">发送</button>
    </div>
</div>

<script>
    let ws = null;
    let userId = null;

    // 登录连接 Netty 服务
    function login() {
        userId = document.getElementById("userId").value.trim();
        if (!userId) {
            alert("请输入用户名！");
            return;
        }

        // 连接 Netty WebSocket 服务（注意协议是 ws，端口是 Netty 配置的 8088）
        ws = new WebSocket(`ws://${window.location.hostname}:8088/ws/chat`);

        // 连接成功
        ws.onopen = function() {
            console.log("连接成功");
            // 发送登录消息
            const loginMsg = {
                type: 1,
                senderId: userId,
                timestamp: Date.now()
            };
            ws.send(JSON.stringify(loginMsg));
        };

        // 接收消息
        ws.onmessage = function(event) {
            const msg = JSON.parse(event.data);
            renderMsg(msg);
        };

        // 连接关闭
        ws.onclose = function() {
            console.log("连接关闭");
            addSystemMsg("连接已断开，刷新页面重新登录");
        };

        // 连接异常
        ws.onerror = function(error) {
            console.error("连接异常：", error);
            addSystemMsg("连接失败，请检查服务是否启动");
        };
    }

    // 发送消息
    function sendMsg() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            alert("请先登录！");
            return;
        }

        const receiverType = document.getElementById("receiverType").value;
        const receiverId = receiverType === "single"
            ? document.getElementById("receiverId").value.trim()
            : "all";
        const content = document.getElementById("msgContent").value.trim();

        if (!content) {
            alert("请输入消息内容！");
            return;
        }

        if (receiverType === "single" && !receiverId) {
            alert("单聊请输入对方用户名！");
            return;
        }

        // 构建消息
        const msg = {
            type: receiverType === "single" ? 2 : 3,
            senderId: userId,
            receiverId: receiverId,
            content: content,
            timestamp: Date.now()
        };

        ws.send(JSON.stringify(msg));
        // 清空输入框
        document.getElementById("msgContent").value = "";
        // 本地渲染自己发送的消息
        renderMsg(msg);
    }

    // 渲染消息到页面
    function renderMsg(msg) {
        const msgList = document.getElementById("msgList");
        const div = document.createElement("div");
        div.className = "msg";

        if (msg.type === 4) { // 系统通知
            div.className = "msg system-msg";
            div.innerText = `[${formatTime(msg.timestamp)}] 系统通知：${msg.content}`;
        } else if (msg.senderId === userId) { // 自己发送的消息
            div.className = "msg send-msg";
            div.innerText = `[${formatTime(msg.timestamp)}] 我 → ${msg.receiverId === "all" ? "所有人" : msg.receiverId}：${msg.content}`;
        } else { // 接收的消息
            div.className = "msg recv-msg";
            div.innerText = `[${formatTime(msg.timestamp)}] ${msg.senderId} → 我：${msg.content}`;
        }

        msgList.appendChild(div);
        // 滚动到最新消息
        msgList.scrollTop = msgList.scrollHeight;
    }

    // 添加系统消息
    function addSystemMsg(content) {
        const msgList = document.getElementById("msgList");
        const div = document.createElement("div");
        div.className = "msg system-msg";
        div.innerText = `[${formatTime(Date.now())}] 系统通知：${content}`;
        msgList.appendChild(div);
    }

    // 时间格式化
    function formatTime(timestamp) {
        const date = new Date(timestamp);
        return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}`;
    }
</script>
</body>
</html>