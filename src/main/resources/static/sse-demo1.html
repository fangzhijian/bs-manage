
<!DOCTYPE html>
<html lang="ch">
<head>
    <meta charset="UTF-8">
    <title>SSE Demo</title>
</head>
<body>
<h1>SSE 客户端测试</h1>

<label for="clientId">客户端ID: </label>
<input type="text" id="clientId" value="test-client-1">
<button onclick="connectSSE()">连接SSE</button>
<button onclick="closeSSE()">断开连接</button>

<hr>
<label for="message">要发送的消息: </label>
<input type="text" id="message" value="Hello SSE!">
<button onclick="sendMessage()">发送消息</button>

<hr>
<h3>收到的事件：</h3>
<div id="messages"></div>

<script>
    let eventSource;

    function connectSSE() {
        const clientId = document.getElementById('clientId').value;
        // 断开现有连接
        if (eventSource) {
            eventSource.close();
        }

        // 建立新的 SSE 连接
        eventSource = new EventSource(`http://localhost:8086/p/live/connect?clientId=${clientId}&liveId=1&userId=7`);
        // eventSource = new EventSource(`/connect?clientId=${clientId}`);

        // 监听通用消息（没有指定 event name 的消息）
        eventSource.onmessage = function (event) {
            appendMessage(`[message]: ${event.data}`);
        };

        // 监听特定名称的事件 (例如：MESSAGE)
        eventSource.addEventListener("MESSAGE", function (event) {
            appendMessage(`[MESSAGE]: ${event.data}`);
        });

        // 监听特定名称的事件 (例如：INIT)
        eventSource.addEventListener("INIT", function (event) {
            appendMessage(`[INIT]: ${event.data}`);
        });
        // 监听特定名称的事件 (例如：HEARTBEAT)
        eventSource.addEventListener("HEARTBEAT", function (event) {
            appendMessage(`[HEARTBEAT]: ${event.data}`);
            // console.log(`[HEARTBEAT]: ${event.data}`)
        });

        eventSource.onerror = function (err) {
            console.error("SSE error:", err);
            appendMessage('[错误] 连接出错'+err.type);
            setTimeout(connectSSE, 1000);
        };
    }

    function closeSSE() {
        if (eventSource) {
            eventSource.close();
            appendMessage('[信息] 连接已关闭');
            eventSource = null;
        }
    }

    function sendMessage() {
        const clientId = document.getElementById('clientId').value;
        const message = document.getElementById('message').value;
        fetch(`/push?clientId=${clientId}&message=${encodeURIComponent(message)}`)
            .then(response => response.text())
            .then(data => console.log(data));
    }

    function appendMessage(text) {
        const messageDiv = document.getElementById('messages');
        const p = document.createElement('p');
        p.textContent = `${new Date().toLocaleTimeString()}: ${text}`;
        messageDiv.appendChild(p);
    }
</script>
</body>
</html>
